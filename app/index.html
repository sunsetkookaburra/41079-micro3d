<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>
  <script src="https://geographiclib.sourceforge.io/scripts/geographiclib-geodesic.min.js"></script>
  <!-- Micro:3D Libraries -->
  <style>
    .obj { filter: hue-rotate(150deg) }
    article { width: fit-content }
    canvas {
      background-repeat: no-repeat;
      background-size: contain;
    }
    output {
      display: block;
      border: inset;
      min-height: 1em;
      background-color: #eee;
    }
  </style>
</head>
<body>
<header>
  <h1>Micro3D</h1>
</header>
<main>
  <article id="upload">
    <fieldset>
      <legend>Upload Image to Extract Data</legend>
      <input type="file" accept="image/*"/>
      <pre><output></output></pre>
    </fieldset>
  </article>
  <article id="input">
    <fieldset>
      <legend>Input Micro3D Capture JSON File</legend>
      <textarea></textarea><br/>
      <button>Compute</button>
    </fieldset>
  </article>
  <article id="bboxes">
    <fieldset>
      <legend>Preview Bboxes</legend>
    </fieldset>
  </article>
  <article>
    <fieldset>
      <legend>Correlation Results</legend>
      <div id="preview" style="width:600px;height:400px;"></div>
    </fieldset>
  </article>
</main>
<script type="module">
  import * as L from "../lib/leaflet-src.esm.js";
  import { bboxToSvg } from "./bbox.mjs";
  import { CaptureRig } from "./rig.mjs";
  import { correlate } from "./correlate.mjs";
  import { extractEXIF } from "./exif.mjs";

  const map = L.map("preview")
    .setView([0, 0], 1)
    .addLayer(L.tileLayer(
      "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
      { maxNativeZoom: 19, maxZoom: 21 },
    ));

  const markers = L.featureGroup().addTo(map);

  const fileUploadInput = document.querySelector(`#upload input[type="file"]`);
  fileUploadInput.value = "";
  fileUploadInput.addEventListener("input", async () => {
    const data = URL.createObjectURL(fileUploadInput.files[0]);
    const exif = await fetch(data).then(r => r.arrayBuffer()).then(buf => extractEXIF(buf));
    document.querySelector("#upload output").innerText = JSON.stringify(exif, null, 2);
  });

  const captureInputArea = document.querySelector("#input textarea");
  captureInputArea.value = "";
  captureInputArea.addEventListener("change", () => {
    const capture = JSON.parse(captureInputArea.value);
    const bboxParent = document.querySelector("#bboxes fieldset");
    const oldSvgs = document.querySelectorAll("#bboxes svg");
    for (const svg of oldSvgs) {
      svg.parentElement.removeChild(svg);
    }
    for (const [frameId, frame] of Object.entries(capture["frames"])) {
      bboxParent.insertAdjacentHTML(
        "beforeend",
        bboxToSvg(frame)
      );
    }
    markers.clearLayers();
    const { features, frames } = correlate(capture);
    for (const [feature_id, { coords, tags }] of Object.entries(features)) {
      markers.addLayer(L.marker(
        [coords.lat, coords.lon],
        {
          riseOnHover: true,
          icon: new L.Icon.Default({ className: "obj" }),
        }
      ));
    }
    for (const [frame_id, { coords }] of Object.entries(frames)) {
      markers.addLayer(L.marker([coords.lat, coords.lon]));
    }
    if (markers.getLayers().length > 0) {
      map.fitBounds(markers.getBounds());
    }
  });
</script>
</body>
</html>
